| version        | statements                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | name                   |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------- |
| 20250328135512 | ["-- Create collections table\r\nCREATE TABLE collections (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\r\n  name VARCHAR(255) NOT NULL,\r\n  description TEXT,\r\n  libraries TEXT [] NOT NULL DEFAULT '{}',\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()) NOT NULL,\r\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()) NOT NULL\r\n)","-- Create index on user_id for faster lookups\r\nCREATE INDEX collections_user_id_idx ON collections(user_id)","-- Enable Row Level Security\r\nALTER TABLE collections ENABLE ROW LEVEL SECURITY","-- Create policy to allow users to manage their own collections\r\nCREATE POLICY \"Users can manage their own collections\" ON collections FOR ALL USING (auth.uid() = user_id)","-- Function to automatically update updated_at timestamp\r\nCREATE OR REPLACE FUNCTION update_updated_at_column() RETURNS TRIGGER AS $$ BEGIN NEW.updated_at = TIMEZONE('utc', NOW());\r\nRETURN NEW;\r\nEND;\r\n$$ language 'plpgsql'","-- Trigger to call the update function\r\nCREATE TRIGGER update_collections_updated_at BEFORE\r\nUPDATE ON collections FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | collections            |
| 20250328201010 | ["-- Disable Row Level Security\r\nALTER TABLE collections DISABLE ROW LEVEL SECURITY","-- Remove policy to allow users to manage their own collections\r\nDROP POLICY \"Users can manage their own collections\" ON collections"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | drop-rls               |
| 20250402082709 | ["-- Migration: Add Row Level Security (RLS) to collections table\r\n-- Description: Enables RLS and adds granular policies for collections table access control\r\n-- Author: AI Rules Builder Team\r\n-- Date: 2024-04-02\r\n-- Enable RLS on collections table\r\nalter table public.collections enable row level security","-- Comment on table to document RLS implementation\r\ncomment on table public.collections is 'Collections table with RLS enabled. Access controlled by user_id for authenticated users.'","-- Policy for authenticated users to select their own collections\r\ncreate policy \"Users can view their own collections\" on public.collections for\r\nselect to authenticated using (auth.uid() = user_id)","-- Policy for authenticated users to insert their own collections\r\ncreate policy \"Users can insert their own collections\" on public.collections for\r\ninsert to authenticated with check (auth.uid() = user_id)","-- Policy for authenticated users to update their own collections\r\ncreate policy \"Users can update their own collections\" on public.collections for\r\nupdate to authenticated using (auth.uid() = user_id) with check (auth.uid() = user_id)","-- Policy for authenticated users to delete their own collections\r\ncreate policy \"Users can delete their own collections\" on public.collections for delete to authenticated using (auth.uid() = user_id)","-- Policy for anonymous users to view collections (if needed in the future, currently disabled)\r\ncreate policy \"Anonymous users cannot access collections\" on public.collections for all to anon using (false)"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | add_rls_to_collections |
| 20250411083417 | ["-- Migration: Create user consents table\r\n-- Description: Stores user consent records for privacy policy acceptance\r\n-- Tables affected: user_consents\r\n-- Special considerations: Implements RLS for data protection\r\n-- Create user consents table\r\ncreate table user_consents (\r\n  id uuid default gen_random_uuid() primary key,\r\n  user_id uuid references auth.users(id) on delete cascade not null,\r\n  privacy_policy_version text not null,\r\n  consented_at timestamptz default now() not null,\r\n  ip_address text,\r\n  user_agent text,\r\n  created_at timestamptz default now() not null\r\n)","-- Enable RLS\r\nalter table user_consents enable row level security","-- Create indexes\r\ncreate index user_consents_user_id_idx on user_consents(user_id)","-- Comments\r\ncomment on table user_consents is 'Stores user consent records for privacy policy and other terms'","comment on column user_consents.privacy_policy_version is 'Version or date of the privacy policy that was accepted'","comment on column user_consents.ip_address is 'IP address of the user when consent was given'","comment on column user_consents.user_agent is 'Browser user agent when consent was given'","-- RLS Policies for authenticated users\r\ncreate policy \"Users can view their own consents\" on user_consents for\r\nselect to authenticated using (auth.uid() = user_id)","create policy \"Users can insert their own consents\" on user_consents for\r\ninsert to authenticated with check (auth.uid() = user_id)","-- RLS Policies for anonymous users (view only for verification purposes)\r\ncreate policy \"Anonymous users cannot view consents\" on user_consents for\r\nselect to anon using (false)","create policy \"Anonymous users cannot insert consents\" on user_consents for\r\ninsert to anon with check (false)"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | create_user_consents   |
| 20250413093000 | ["-- Prompt Manager Phase 2: foundational organization tables\nCREATE TABLE IF NOT EXISTS organizations (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  slug TEXT NOT NULL UNIQUE,\n  name TEXT NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW())\n)","CREATE TABLE IF NOT EXISTS organization_members (\n  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('member', 'admin')),\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\n  PRIMARY KEY (organization_id, user_id)\n)","CREATE INDEX IF NOT EXISTS organization_members_user_id_idx\n  ON organization_members(user_id)","-- Seed the launch organization; memberships are populated via the launch roster sync runbook.\nINSERT INTO organizations (slug, name)\nVALUES ('10xdevs', '10xDevs')\nON CONFLICT (slug) DO NOTHING","-- Placeholder membership seed leveraging known launch member emails. Update the array before rollout.\nWITH launch_members(email, role) AS (\n  VALUES\n    ('kontakt@marcinczarkowski.pl', 'member'),\n    ('marcin@przeprogramowani.pl', 'admin')\n), matched_users AS (\n  SELECT users.id, launch_members.role\n  FROM auth.users AS users\n  JOIN launch_members ON users.email = launch_members.email\n), target_org AS (\n  SELECT id\n  FROM organizations\n  WHERE slug = '10xdevs'\n)\nINSERT INTO organization_members (organization_id, user_id, role)\nSELECT target_org.id, matched_users.id, matched_users.role\nFROM target_org\nJOIN matched_users ON TRUE\nON CONFLICT DO NOTHING"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | prompt_manager_orgs    |
| 20251001211923 | ["-- Prompt Manager Phase 3: Prompt Collection Schema & Catalog\r\n-- Create prompt collections table\r\nCREATE TABLE IF NOT EXISTS prompt_collections (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\r\n  slug TEXT NOT NULL,\r\n  title TEXT NOT NULL,\r\n  description TEXT,\r\n  sort_order INTEGER NOT NULL DEFAULT 0,\r\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\r\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\r\n  UNIQUE (organization_id, slug)\r\n)","CREATE INDEX IF NOT EXISTS idx_prompt_collections_org_sort\r\n  ON prompt_collections(organization_id, sort_order)","-- Create collection segments table\r\nCREATE TABLE IF NOT EXISTS prompt_collection_segments (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  collection_id UUID NOT NULL REFERENCES prompt_collections(id) ON DELETE CASCADE,\r\n  slug TEXT NOT NULL,\r\n  title TEXT NOT NULL,\r\n  sort_order INTEGER NOT NULL DEFAULT 0,\r\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\r\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\r\n  UNIQUE (collection_id, slug)\r\n)","CREATE INDEX IF NOT EXISTS idx_prompt_segments_collection_sort\r\n  ON prompt_collection_segments(collection_id, sort_order)","-- Create prompts table (single active version per prompt)\r\nCREATE TABLE IF NOT EXISTS prompts (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\r\n  collection_id UUID NOT NULL REFERENCES prompt_collections(id) ON DELETE CASCADE,\r\n  segment_id UUID REFERENCES prompt_collection_segments(id) ON DELETE SET NULL,\r\n  title TEXT NOT NULL,\r\n  markdown_body TEXT NOT NULL,\r\n  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published')),\r\n  created_by UUID REFERENCES auth.users(id),\r\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW()),\r\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT TIMEZONE('utc', NOW())\r\n)","CREATE INDEX IF NOT EXISTS idx_prompts_org_scope\r\n  ON prompts(organization_id, status, collection_id, segment_id)","-- Seed demo collections for 10xDevs\r\nDO $$\r\nDECLARE\r\n  v_org_id UUID;\r\n  v_coll1_id UUID;\r\n  v_coll2_id UUID;\r\n  v_seg1_id UUID;\r\n  v_seg2_id UUID;\r\nBEGIN\r\n  -- Get 10xDevs organization ID\r\n  SELECT id INTO v_org_id FROM organizations WHERE slug = '10xdevs';\r\n\r\n  IF v_org_id IS NULL THEN\r\n    RAISE EXCEPTION '10xDevs organization not found';\r\n  END IF;\r\n\r\n  -- Insert collections\r\n  INSERT INTO prompt_collections (organization_id, slug, title, description, sort_order)\r\n  VALUES\r\n    (v_org_id, 'fundamentals', 'Fundamentals', 'Core prompts for foundational concepts', 1),\r\n    (v_org_id, 'advanced', 'Advanced Topics', 'Advanced prompts for experienced developers', 2)\r\n  ON CONFLICT (organization_id, slug) DO NOTHING;\r\n\r\n  -- Get collection IDs\r\n  SELECT id INTO v_coll1_id FROM prompt_collections WHERE organization_id = v_org_id AND slug = 'fundamentals';\r\n  SELECT id INTO v_coll2_id FROM prompt_collections WHERE organization_id = v_org_id AND slug = 'advanced';\r\n\r\n  -- Insert segments\r\n  INSERT INTO prompt_collection_segments (collection_id, slug, title, sort_order)\r\n  VALUES\r\n    (v_coll1_id, 'getting-started', 'Getting Started', 1),\r\n    (v_coll1_id, 'best-practices', 'Best Practices', 2)\r\n  ON CONFLICT (collection_id, slug) DO NOTHING;\r\n\r\n  -- Get segment IDs\r\n  SELECT id INTO v_seg1_id FROM prompt_collection_segments WHERE collection_id = v_coll1_id AND slug = 'getting-started';\r\n  SELECT id INTO v_seg2_id FROM prompt_collection_segments WHERE collection_id = v_coll1_id AND slug = 'best-practices';\r\n\r\n  -- Insert sample prompts\r\n  INSERT INTO prompts (organization_id, collection_id, segment_id, title, markdown_body, status)\r\n  VALUES\r\n    (\r\n      v_org_id,\r\n      v_coll1_id,\r\n      v_seg1_id,\r\n      'Project Setup Guide',\r\n      '# Project Setup\r\n\r\nThis prompt helps you set up a new project with best practices.\r\n\r\n## Steps\r\n1. Initialize repository\r\n2. Configure tooling\r\n3. Set up CI/CD',\r\n      'published'\r\n    ),\r\n    (\r\n      v_org_id,\r\n      v_coll1_id,\r\n      v_seg2_id,\r\n      'Code Review Checklist',\r\n      '# Code Review Checklist\r\n\r\nUse this checklist when reviewing pull requests.\r\n\r\n- [ ] Tests pass\r\n- [ ] Code follows style guide\r\n- [ ] Documentation updated',\r\n      'draft'\r\n    )\r\n  ON CONFLICT DO NOTHING;\r\nEND $$"] | prompt_manager_catalog |